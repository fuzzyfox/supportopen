/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */
var module=module||void 0;!function(a){"use strict";function m(a,b,c,d){var j,e=h&&i?{username:h,password:i,sendImmediately:!0}:void 0,g={method:a,uri:b,json:c,headers:{}};e?g.auth=e:f&&(j=l.client.header(b,a,{credentials:f}),g.headers.Authorization=j.field),k(g,function(a,b,c){return a?d(a):f&&!l.client.authenticate(b,f,j.artifacts,{payload:JSON.stringify(c)})?d("Warning: The response does not authenticate - your traffic may be getting intercepted and modified"):(200===b.statusCode?d(null,c):d(c),void 0)})}function n(a,b,c,d){var e=new XMLHttpRequest;g?e.open(a,b,!0,h,i):e.open(a,b,!0),j&&e.setRequestHeader("x-csrf-token",j),e.setRequestHeader("Content-Type","application/json; charset=utf-8"),e.onreadystatechange=function(){var a,b;if(4===this.readyState){try{a=JSON.parse(this.responseText),b=a.error}catch(c){b=c}b?d(b):d(null,a)}},e.send(JSON.stringify(c))}function o(a,b,c,f){"function"==typeof c?(f=c,c={}):"string"==typeof c&&(b=c.length?b+"?"+c:b,c={}),b=e+b,d(a,b,c,f)}function p(a,b){function d(){return d.instance||(d.instance=c(b)),d.instance}function e(b,c,d){delete b[c];var e=[];return a.tags.forEach(function(a){d.test(a)&&e.push(a)}),b[c]=e,e}var f={get appTags(){return e(this,"appTags",/^[^@]+\:[^:]+/)},get userTags(){return e(this,"userTags",/^[^@]+@[^@]+\:[^:]+/)},get rawTags(){return e(this,"rawTags",/^[^:]+$/)},taggedWithAny:function(b){var d=a.tags;b=Array.isArray(b)?b:[b];for(var e=0;e<b.length;e++)if(d.indexOf(b[e])>-1)return!0;return!1},remixes:function(a){a=a||function(){},d().find({remixedFrom:f._id}).then(a)},locales:function(a){a=a||function(){},this.remixes(function(b,c){if(b)return a(b),void 0;var d=[];c.forEach(function(a){a.locale!==f.locale&&d.push(a)}),a(null,d)})},original:function(a){return a=a||function(){},f.remixedFrom?(d().find({_id:f._id}).then(a),void 0):(a(null,null),void 0)},update:function(a,b){b=b||function(){},d().update(f._id,f,b)}};return["url","contentType","locale","title","description","author","published","tags","thumbnail","username","remixedFrom","_id","emailHash","createdAt","updatedAt","likes","reports"].forEach(function(b){f[b]=a[b]}),f.id=f._id,f}var c,d,e,f,g,h,i,j,k,l,b="/api/20130724/make/";c=function(a){function c(a){return a.map(function(a){return a.trim()}).join(",")}return e=a.apiURL,a.hawk?f=a.hawk:a.auth&&(g=a.auth.split(":"),h=g[0],i=g[1]),a.csrf&&(j=a.csrf),{queryPairs:[],addPair:function(a,b,c){return b=b?b.toString():"",b.length?(b=c?"{!}"+b:b,this.queryPairs.push(encodeURIComponent(a)+"="+encodeURIComponent(b)),this):this},find:function(a){a=a||{};for(var b in a)a.hasOwnProperty(b)&&this[b]&&(Array.isArray(a[b])?this[b].apply(this,a[b]):this[b](a[b]));return this},author:function(a,b){return this.addPair("author",a,b)},user:function(a,b){return this.addPair("user",a,b)},tags:function(a,b){if(a){var d=a.tags||a,e=a.execution||"and";return d=Array.isArray(d)?c(d):c(d.split(",")),d=e+","+d,this.addPair("tags",d,b)}return this},tagPrefix:function(a,b){return this.addPair("tagPrefix",a,b)},url:function(a,b){return this.addPair("url",a,b)},contentType:function(a,b){return this.addPair("contentType",a,b)},remixedFrom:function(a,b){return this.addPair("remixedFrom",a,b)},id:function(a,b){return this.addPair("id",a,b)},title:function(a,b){return this.addPair("title",a,b)},description:function(a,b){return this.addPair("description",a,b)},limit:function(a){return this.addPair("limit",a)},page:function(a){return this.addPair("page",a)},sortByField:function(a,b){var c;return"string"==typeof a?(c=a,c+=","+(b?b:"desc"),this.addPair("sortByField",c)):this},or:function(){return this.addPair("or","1")},then:function(c){var d=this.queryPairs.join("&");this.queryPairs=[],o("GET",b+"search",d,function(b,d){if(b)c(b);else{for(var e=d.makes,f=0;f<e.length;f++)e[f]=p(e[f],a);c(null,e,d.total)}})},create:function(a,c){return o("POST",b,a,c),this},update:function(a,c,d){return o("PUT",b+a,c,d),this},like:function(a,c,d){return o("PUT",b+"like/"+a,{maker:c},d),this},unlike:function(a,c,d){return o("PUT",b+"unlike/"+a,{maker:c},d),this},remove:function(a,c){return o("DELETE",b+a,c),this},report:function(a,c,d){return o("PUT",b+"report/"+a,{maker:c},d),this},cancelReport:function(a,c,d){return o("PUT",b+"cancelReport/"+a,{maker:c},d),this}}},"undefined"!=typeof a&&a.exports?(k=require("request"),l=require("hawk"),d=m,a.exports=c):(d=n,"function"==typeof define&&define.amd?define(function(){return c}):window.Make=c)}(module);